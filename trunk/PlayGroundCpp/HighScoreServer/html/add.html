<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head></head>
    <body>
        <h1>High Score Server</h1>
        <table>
          <tr>
            <td>Name:</td>
            <td><input type="text" id="input_name" /></td>
          </tr>
          <tr>
            <td>Score:</td>
            <td><input type="text" id="input_score" /></td>
          </tr>          
        </table>
        <div id="div_output" />
        <script type="text/javascript">
            var PostHelper = {};
            
            PostHelper.init = function()
            {     
              PostHelper.registerInputField("input_name");
              PostHelper.registerInputField("input_score");
              PostHelper.display("Test");
              document.getElementById("input_name").focus();
            };
			
            PostHelper.registerInputField = function(fieldId)
            {      
              var inputField = document.getElementById(fieldId);
              if (!inputField)
              {
                alert("Did not find input field with id: " + fieldId);
                return;
              }
        
              inputField.onkeydown = function(evt)
              {
                if (evt.keyCode == 13)
                {
                  PostHelper.submitHighScore();
                  inputField.value = "";
                }
              };
            };
      
      
            PostHelper.submitHighScore = function()
            {
              PostHelper.send(
                document.getElementById("input_name").value,
                document.getElementById("input_score").value);
            };
      
            
            PostHelper.display = function(message)
            {                 
                var p = document.createElement("p");
                p.innerText = message;
                document.getElementById("div_output").appendChild(p);
            };


            /*PostHelper.submit = function(path, params)
            {
              var form = document.createElement("form");
              form.setAttribute("method", "post");
              form.setAttribute("action", path);

              for(var key in params)
              {
                var hiddenField = document.createElement("input");
                hiddenField.setAttribute("type", "hidden");
                hiddenField.setAttribute("name", key);
                hiddenField.setAttribute("value", params[key]);
                form.appendChild(hiddenField);
              }
              // Not entirely sure if this is necessary
              document.body.appendChild(form);
              form.submit();
            }*/


            PostHelper.getURL = function(action)
            {
              return "http://" + window.location.hostname + "/" + action;
            };

           
            PostHelper.send = function(name, score)
            {
              var httpRequest = new XMLHttpRequest();
              var url = PostHelper.getURL("hs");
              httpRequest.open("POST", url, true);
              httpRequest.setRequestHeader("Accept", "text/plain");
              httpRequest.onreadystatechange = function()
              {
                if(httpRequest.readyState == 4)
                {
                  if (httpRequest.status == 200)
                  {
                    // The response will be a url
                    window.location.href = PostHelper.getURL(httpRequest.responseText);
                  }
                  else
                  {
                    PostHelper.display("Readystate is: " + httpRequest.status);
                    PostHelper.display("Oops, it doesn't work...\n");
                  }
                }
              };
              var body = "name=" + name + "&score=" + score;
              httpRequest.send(body);
            };         
            window.onload = PostHelper.init();
        </script>   
    </body>
</html>
