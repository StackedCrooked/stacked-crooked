<script src="base64.js" ></script>
<script>
try {


function assertProperty(obj, prop) {
	if (obj[prop] === undefined) {
		throw arguments.callee.caller.toString() + "\n\nMissing property: '" + prop + "'.";
	}
}


function assert(obj) {
	if (obj === undefined || obj === null || obj === false) {
		throw "Failed assert: " + arguments.callee.caller.toString();
	}
}


function log(value) {
		console.log(JSON.stringify(value));
}


function getAuthorization(login) {
	return "Basic " + Base64.encode(login);
}

function PerformHTTPRequest(url, auth, callback) {
		var http = new window.XMLHttpRequest();
		http.onreadystatechange = function() {
				if (http.readyState == 4) {
						if (http.status == 200) {
								log(http);
								callback(http.responseText);
						}
						else {
								log(http);
						}
				}
		};
		http.open('GET', url, true);
		http.setRequestHeader('Authorization', auth);
		http.send();
}

function Search(word, callback) {
		var auth = "Basic U3RhY2tlZENyb29rZWQ6T3N0cm92OTk=";
		var url = encodeURI("http://myanimelist.net/api/anime/search.xml?q=" + word);
		PerformHTTPRequest(
				url, auth,
				function(response) {
						callback(response);
				}
		);
}

function getMalInfo(arg, callback) {
	assertProperty(arg, "title");
	Search(arg.title, function(xml) {
		var parser = new DOMParser();
		var doc = parser.parseFromString(xml, "text/xml");
		var animes = doc.getElementsByTagName("anime");
		if (animes.length === 0) {
			console.log("WARNING: No result set is empty!");
			result.success = false;
			callback(result);
		}
		else {
			var anime = animes[0];
			var result = {};
			result.success = true;

			var scoreNodes = anime.getElementsByTagName("score");
			assert(scoreNodes !== undefined);
			assert(scoreNodes !== null);
			assert(scoreNodes.length === 1);
			result.score = scoreNodes[0].childNodes[0].nodeValue;

			var idNodes = anime.getElementsByTagName("id");
			assert(idNodes !== undefined);
			assert(idNodes !== null);
			assert(idNodes.length === 1);
			result.url = "http://myanimelist.net/anime/" + idNodes[0].childNodes[0].nodeValue;
			callback(result);
		}
	});
}


chrome.extension.onRequest.addListener( function(request, sender, callback) {
	if (request.action === "log") {
		console.log(JSON.stringify(request.arg));
		request.success = true;
		request.sender = sender;
		callback(request);
	}
	else if (request.action === "getMalInfo") {
		getMalInfo(request.arg, callback);
	}
	else {
		throw "Invalid request: " + JSON.stringify(request);
	}
});

} catch(exc) {
 console.log(JSON.stringify(exc));
}

</script>

