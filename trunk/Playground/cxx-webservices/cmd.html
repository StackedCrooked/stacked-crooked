<html>
<head>
    <style type="text/css">

        .cpp {
            position: relative;
            width: 100%;
        }

        #input   { height: 80% ; resize:none; }
        #output  { height: 20% ; resize:none; }



    </style>
    <script type="text/javascript">


        var app = {};


        app.log = function (msg) {
            console.log(msg);
        };

        app.input = document.getElementById("input");
        app.inputMargin = 10;


        app.send = function (title, payload) {
            app.log('payload: ' + payload);
            var httpRequest = new XMLHttpRequest();

            var url = "http://" + window.location.hostname + ":" + window.location.port + '/compile';

            app.log("POST to " + url);
            httpRequest.open("PUT", url, false);

            httpRequest.onreadystatechange = function () {
                if (httpRequest.readyState == 4) {
                    if (httpRequest.status == 200) {
                        app.log('HTTP STATUS 200');
                        app.log(JSON.stringify(httpRequest));
                        app.onReply(httpRequest.responseText);
                    } else {
                        app.log("HTTP STATUS " + httpRequest.status);
                    }
                } else {
                    app.log("HTTP STATUS " + httpRequest.status);
                    app.log("httpRequest.readyState: " + httpRequest.readyState);
                }
            };
            httpRequest.send(payload);
        };

        window.onload = function () {
            app.log("window.onload");
            app.input = document.getElementById("input");
            app.output = document.getElementById("output");


            app.input.onkeydown = function(e) {
                app.changed = true;
                if (!e && event.keyCode == 9)
                {
                    event.returnValue = false;
                    insertAtCursor(app.input, "    ");
                }
                else if (e.keyCode == 9)
                {
                    e.preventDefault();
                    insertAtCursor(app.input, "    ");
                }
            };

            app.enterTimeoutLoop();
        };

        app.changed = false;


        app.enterTimeoutLoop = function () {
            if (app.changed === true) {
                app.onCompile();
                app.changed = false;
            }
            window.setTimeout(app.enterTimeoutLoop, 1000);
        };


        app.onCompile = function () {
            app.log('app.onCompile');
            app.send("compile", app.input.value);
        };

        app.onReply = function (reply) {
            app.output.value = reply;
        };

        function insertAtCursor(myField, myValue) {
            //IE support
            if (document.selection) {
                var temp;
                myField.focus();
                sel = document.selection.createRange();
                temp = sel.text.length;
                sel.text = myValue;
                if (myValue.length == 0) {
                    sel.moveStart('character', myValue.length);
                    sel.moveEnd('character', myValue.length);
                } else {
                    sel.moveStart('character', -myValue.length + temp);
                }
                sel.select();
            }
            //MOZILLA/NETSCAPE support
            else if (myField.selectionStart || myField.selectionStart == '0') {
                var startPos = myField.selectionStart;
                var endPos = myField.selectionEnd;
                myField.value = myField.value.substring(0, startPos) + myValue + myField.value.substring(endPos, myField.value.length);
                myField.selectionStart = startPos + myValue.length;
                myField.selectionEnd = startPos + myValue.length;
            } else {
                myField.value += myValue;
            }
        }


    </script>
</head>
<body>

<span id="input_span" class="cpp">
    <label for="input"></label>
    <textarea id="input" class="cpp">int main() {}</textarea>
</span>


<span id="output_span" class="cpp">
    <label for="output"></label>
    <textarea id="output" class="cpp"></textarea>
</span>


</body>
</html>
