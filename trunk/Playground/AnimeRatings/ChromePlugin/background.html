<script src="base64.js" ></script>
<script>
try {


function assertProperty(obj, prop) {
	if (obj[prop] === undefined) {
		throw arguments.callee.caller.toString() + "\n\nMissing property: '" + prop + "'.";
	}
}


function assert(obj) {
	if (obj === undefined || obj === null || obj === false) {
		throw "Failed assert: " + arguments.callee.caller.toString();
	}
}


function log(value) {
		console.log(JSON.stringify(value));
}


function getAuthorization(login) {
	return "Basic " + Base64.encode(login);
}

function PerformHTTPRequest(url, auth, callback) {
	var http = new window.XMLHttpRequest();
	http.onreadystatechange = function() {
		if (http.readyState == 4) {
			if (http.status == 200) {
				callback({success: true, value: http.responseText});
			}
			else {
				console.log(JSON.stringify(http));
				callback({success: false, value: http.status});
			}
		}
	};
	http.open('GET', url, true);
	http.setRequestHeader('Authorization', auth);
	http.send();
}

function Search(title, callback) {
	var auth = "Basic QW5pbWVSYXRpbmdzOkNocm9tZQ==";
	var url = "http://myanimelist.net/api/anime/search.xml?q=" + encodeURIComponent(title);
	PerformHTTPRequest(url, auth, function(response) {
		callback(response);
	});
}

function getInnerText(node) {
	if (node.childNodes.length === 0) {
		return null;
	}
	return node.childNodes[0].nodeValue;
}

function getNodeValue(node, prop) {
	var children = node.getElementsByTagName(prop);
	if (children.length === 0) {
		return null;
	}
	return getInnerText(children[0]);
}


function getMalInfo(arg, callback) {
	assertProperty(arg, "title");

	Search(arg.title, function(response) {
		var result = {};
		result.success = false;
		result.entries = [];
		if (response.success === false) {
			result.reason = response.value;
			callback(result);
			return;
		}

		var parser = new DOMParser();
		var doc = parser.parseFromString(response.value, "text/xml");
		var entries = doc.getElementsByTagName("entry");
		if (entries.length === 0) {
			result.reason = "Result set is empty.";
			callback(result);
			return;
		}

		for (var i = 0; i < entries.length; ++i) {
			var node = entries[i];

			var entry = {
				url: "http://myanimelist.net/anime/" + getNodeValue(node, "id"),
				title: getNodeValue(node, "title"),
				score: getNodeValue(node, "score")
			};
			result.entries.push(entry);
		}

		result.success = true;
		callback(result);
	});
}


chrome.extension.onRequest.addListener( function(request, sender, callback) {
	if (request.action === "log") {
		console.log(JSON.stringify(request.arg));
		request.success = true;
		request.sender = sender;
		callback(request);
	}
	else if (request.action === "getMalInfo") {
		getMalInfo(request.arg, callback);
	}
	else {
		throw "Invalid request: " + JSON.stringify(request);
	}
});

} catch(exc) {
 console.log(JSON.stringify(exc));
}

</script>

