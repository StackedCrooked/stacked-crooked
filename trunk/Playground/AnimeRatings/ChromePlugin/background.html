<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<script>
try {

function performHTTPGETRequest(url, auth, callback) {
	var http = new window.XMLHttpRequest();
	http.onreadystatechange = function() {
		if (http.readyState == 4) {
			if (http.status == 200) {
				callback({success: true, value: http.responseText});
			}
			else {
				console.log("Failure (" + http.status + "): " + url);
				callback({success: false, value: http.status});
			}
		}
	};
	http.open('GET', url, true);
	http.setRequestHeader('Authorization', auth);
	http.send();
}

function getURL(pageType, title) {
	return "http://myanimelist.net/api/" + pageType +
			 "/search.xml?q=" + encodeURIComponent(title);
}

function searchMAL(pageType, title, callback) {
	var auth = "Basic QW5pbWVSYXRpbmdzOkNocm9tZQ==";
	var url = getURL(pageType, title);
	performHTTPGETRequest(url, auth, function(response) {
		callback(response);
	});
}

function htmlDecode(input){
	var e = document.createElement('div');
	e.innerHTML = input;
	return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
}

function xmlDecode(input){
	var result = input;
	result = result.replace(/</g,  "&lt;");
	result = result.replace(/>/g,  "&gt;");
	result = result.replace(/\n/g, "&#10;");
	return result;
}

/**
 * For some reason the unicode in the xml response
 * is wrong. Either I am doing something wrong, or
 * MAL wrongly encodes the response.
 *
 * This code is a workaround that provides fixes
 * for common cases.
 */
function fixUnicode(input) {
	var result = input;
	// Hacks
	var mapping = {
		"&Atilde;&copy;" : "é",
		"&acirc;��"     : "-"
	};

	for (var key in mapping) {
		var value = mapping[key];
		var count = 0;
		while (result.search(key) !== -1) {
			result = result.replace(key, value);
			if (count++ > 20) {
				console.log("Problematic replacement key: " + key);
				break;
			}
		}
	}
	return result;
}

function getInnerText(node) {
	if (node.childNodes.length === 0) {
		return "";
	}
	return node.childNodes[0].nodeValue;
}

function getCacheKey(pageType, title) {
	return pageType + "_" + title;
}

function getMalInfo(arg, callback) {
	var enableLocalStorage = true;

	if (enableLocalStorage === true) {
		var cacheValue = localStorage.getItem(getCacheKey(arg.pageType, arg.title));
		if (cacheValue !== null) {
			var result = JSON.parse(cacheValue);
			callback(result);
			return;
		}
	}

	searchMAL(arg.pageType, arg.title, function(response) {

		var result = {
			success: false,
			entries : []
		};

		if (response.success === false) {
			callback(result);
			return;
		}

		var parser = new DOMParser();
		var xmlText = response.value;
		var doc = parser.parseFromString(htmlDecode(fixUnicode(xmlDecode(xmlText))), "text/xml");
		var entries = doc.getElementsByTagName("entry");

		for (var i = 0; i < entries.length; ++i) {
			var node = entries[i];

			// Get english title or original title.
			var titles = node.getElementsByTagName("english");

			// If there is no english title, use the original title.
			if (titles.length === 0 ||
				getInnerText(titles[0]).replace(/ /g, "") === "") {
				titles = node.getElementsByTagName("title");
			}

			var scores = node.getElementsByTagName("score");
			var ids = node.getElementsByTagName("id");
			var start_dates = node.getElementsByTagName("start_date");

			if (titles.length === 1 && scores.length === 1 && ids.length === 1) {

				var entry = {
					title: getInnerText(titles[0]),
					score: getInnerText(scores[0]),
					id: getInnerText(ids[0]),
					start_date : getInnerText(start_dates[0])
				};

				result.entries.push(entry);
			}
		}

		if (entries.length !== 0) {
			result.success = true;
		}
		else {
			result.success = false;
		}

		if (enableLocalStorage === true) {
			localStorage.setItem(getCacheKey(arg.pageType, arg.title), JSON.stringify(result));
		}
		callback(result);
	});
}

chrome.extension.onRequest.addListener( function(request, sender, callback) {
	if (request.action === "log") {
		console.log(request.arg);
	}
	else if (request.action === "getMalInfo") {
		getMalInfo(request.arg, callback);
	}
	else {
		throw "Invalid request: " + JSON.stringify(request);
	}
});

}catch(exc) {
	console.log(exc);
}
</script>
